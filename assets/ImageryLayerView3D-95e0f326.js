import{aj as o,ak as m,am as c,aw as v,aB as D,bk as E,bt as u,hh as _,aL as b}from"./index-ab96db07.js";import{N as H}from"./DynamicLayerView3D-5a23ab5a.js";import{i as I}from"./timeSupport-f551a50b.js";import{p as P}from"./popupUtils-5d416a17.js";import"./LayerView3D-2ec8e4f7.js";import"./projectExtentUtils-8de2a3e3.js";import"./ImageMaterial-a207fb63.js";import"./LayerView-ba0f2b5f.js";import"./RefreshableLayerView-5122c702.js";const F=t=>{let e=class extends t{constructor(){super(...arguments),this.view=null}get timeExtent(){return I(this.layer,this.view?.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(a,s){const{layer:r}=this;if(!a)throw new v("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:i}=r,n=P(r,s);if(!i||n==null)return[];const y=await n.getRequiredFields();D(s);const l=new E;l.timeExtent=this.timeExtent,l.geometry=a,l.outFields=y,l.outSpatialReference=a.spatialReference;const{resolution:d,spatialReference:p}=this.view,g=this.view.type==="2d"?new u(d,d,p):new u(.5*d,.5*d,p),{returnTopmostRaster:w,showNoDataRecords:x}=n.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},f={returnDomainValues:!0,returnTopmostRaster:w,pixelSize:g,showNoDataRecords:x,signal:s?.signal};return r.queryVisibleRasters(l,f).then(R=>R)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return o([m()],e.prototype,"layer",void 0),o([m()],e.prototype,"suspended",void 0),o([m({readOnly:!0})],e.prototype,"timeExtent",null),o([m()],e.prototype,"view",void 0),e=o([c("esri.views.layers.ImageryLayerView")],e),e};let h=class extends F(H){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=_(async t=>{this.redraw((e,a)=>this._redrawImage(e,a),t)},2e3)}initialize(){this.addHandles([b(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this._updatingHandles.addPromise(this.redrawDebounced()))]),this._updatingHandles.add(()=>this.layer?.exportImageServiceParameters?.version,()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>this.layer?.renderer,()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>this.timeExtent,()=>this._updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(t,e,a){e.imageOrCanvasElement?t.image=e.imageOrCanvasElement:(t.image=document.createElement("canvas"),t.pixelData=e.pixelData,await this._redrawImage(t,a))}async _redrawImage(t,e){if(!(t.image instanceof HTMLCanvasElement)||t.pixelData==null)throw new Error;const a=t.image,s=a.getContext("2d"),r=await this.layer.applyRenderer(t.pixelData,{signal:e}),i=this.layer.applyFilter(r).pixelBlock;if(i==null)throw new Error;a.width=i.width,a.height=i.height;const n=s.createImageData(i.width,i.height);n.data.set(i.getAsRGBA()),s.putImageData(n,0,0)}};h=o([c("esri.views.3d.layers.ImageryLayerView3D")],h);const $=h;export{$ as default};
