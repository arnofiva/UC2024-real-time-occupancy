import{aj as h,ak as p,am as he,aq as xe,aP as fe,b4 as Ze,cl as vn,aK as wn,fA as li,aQ as le,ai as ci,rT as ui,nE as di,wC as mn,fp as nt,cP as Ue,pV as x,wD as hi,eK as I,cM as y,dZ as se,e3 as Pe,e2 as Me,e0 as Re,e1 as k,dK as pi,wE as Se,vs as fi,ef as Z,hu as A,eO as N,je as b,wF as gi,cR as de,pD as He,d$ as yi,eM as it,wG as St,sn as Sn,eH as st,vt as En,fj as _n,dz as Ae,ed as We,wH as Et,pC as xn,j5 as $n,nM as vi,ox as wi,t5 as Ln,eL as bn,dF as Tn,eY as _,c$ as mi,rk as Ye,jh as Si,s7 as Ei,wI as _i,ee as xi,rF as $i,wJ as Li,pn as bi,wK as Ti,rm as ge,wL as Ri,jf as Pi,te as Ni,wM as Mi,wN as Ai,iI as Fi,wO as Qt,nA as Ci,bk as Vi,dM as Pt,wP as Ii,oR as Oi,aY as Be,dY as Di,pf as je,pd as ji,ej as qe,wQ as dt,ah as zi,wR as Hi,mV as qi,aR as _t,h_ as ki,aB as ht,en as Rn,l2 as Gi,aA as ze,so as Nt,dJ as Zi,eb as Ke,bI as Mt,wS as Ui,wT as Wi,wU as ye,bN as At,bO as Yi,t3 as Bi,wV as Ki,wW as Pn,wX as Nn,eQ as Xi,m2 as Ji,cd as Qi,em as en,gK as es,aJ as ts,bi as ns,wY as is}from"./index-ee8e5ecc.js";import{b as Xe,j as Ft,z as Ct,d as P,A as xt,u as Mn}from"./geodesicLengthMeasurementUtils-a43c4a81.js";import{j as T,d as ss,I as $t,N as rs}from"./geometry2dUtils-bb0dcbdc.js";import{o as as}from"./floorFilterUtils-73949d2d.js";import{c as tn}from"./keybindings-d8b58741.js";function os(t){return t!=null&&typeof t=="object"&&"declaredClass"in t&&t.declaredClass==="esri.WebMap"}let re=class extends xe{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new fe}};h([p({constructOnly:!0})],re.prototype,"layer",void 0),h([p()],re.prototype,"enabled",void 0),h([p()],re.prototype,"updating",void 0),h([p()],re.prototype,"availability",void 0),h([p()],re.prototype,"sublayerSources",void 0),re=h([he("esri.views.interactive.snapping.FeatureSnappingLayerSource")],re);const Vt=re;let H=class extends vn{constructor(){super(...arguments),this.enabled=!0}};h([p({type:Boolean})],H.prototype,"enabled",void 0),H=h([he("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],H);let E=class extends vn{constructor(e){super(e),this.lineSnapper=new H,this.parallelLineSnapper=new H,this.rightAngleSnapper=new H,this.rightAngleTriangleSnapper=new H,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThresholdMeters=.3,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new Ze([255,127,0]),this.orangeTransparent=new Ze([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};h([p({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"lineSnapper",void 0),h([p({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"parallelLineSnapper",void 0),h([p({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"rightAngleSnapper",void 0),h([p({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"rightAngleTriangleSnapper",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],E.prototype,"shortLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],E.prototype,"distance",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"pointThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"intersectionParallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"parallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],E.prototype,"verticalLineThresholdMeters",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"touchSensitivityMultiplier",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"pointOnLineThreshold",void 0),h([p({type:Ze,nonNullable:!0})],E.prototype,"orange",void 0),h([p({type:Ze,nonNullable:!0})],E.prototype,"orangeTransparent",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"lineHintWidthReference",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"lineHintWidthTarget",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],E.prototype,"lineHintFadedExtensions",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"parallelLineHintWidth",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],E.prototype,"parallelLineHintLength",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],E.prototype,"parallelLineHintOffset",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],E.prototype,"rightAngleHintSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],E.prototype,"rightAngleHintOutlineSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],E.prototype,"satisfiesConstraintScreenThreshold",void 0),E=h([he("esri.views.interactive.snapping.Settings.Defaults")],E);const G=new E;let R=class extends xe{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.attributeRulesEnabled=!1,this.featureSources=new fe,this.distance=G.distance,this.touchSensitivityMultiplier=G.touchSensitivityMultiplier}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){const e=this.featureSources;e.some(nn)&&wn.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");const n=e.filter(cs),i=this._get("_effectiveFeatureSources")?.filter(nn)??new fe;for(const l of n){const c=i.find(u=>u.layer===l.layer.parent);if(c)c.sublayerSources.includes(l)||c.sublayerSources.add(l);else if(l.layer.parent){const u=new Vt({layer:l.layer.parent});u.sublayerSources.add(l),i.add(u)}}for(const l of i){const c=l.sublayerSources.filter(u=>!n.includes(u));l.sublayerSources.removeMany(c)}i.removeMany(i.filter(l=>l.sublayerSources.length===0));const s=e.filter(ls),r=this._get("_effectiveFeatureSources")??new fe,{added:a,removed:o}=li(r.toArray(),[...s,...i]);return r.removeMany(o),r.addMany(a),r}};h([p()],R.prototype,"enabled",void 0),h([p()],R.prototype,"enabledToggled",void 0),h([p()],R.prototype,"forceDisabled",void 0),h([p()],R.prototype,"selfEnabled",void 0),h([p()],R.prototype,"featureEnabled",void 0),h([p()],R.prototype,"attributeRulesEnabled",void 0),h([p({type:fe.ofType(Vt)})],R.prototype,"featureSources",void 0),h([p()],R.prototype,"distance",void 0),h([p()],R.prototype,"touchSensitivityMultiplier",void 0),h([p({readOnly:!0})],R.prototype,"effectiveEnabled",null),h([p({readOnly:!0})],R.prototype,"effectiveSelfEnabled",null),h([p({readOnly:!0})],R.prototype,"effectiveFeatureEnabled",null),h([p({readOnly:!0})],R.prototype,"_effectiveFeatureSources",null),R=h([he("esri.views.interactive.snapping.SnappingOptions")],R);const An=R;function nn(t){return t.layer.type==="subtype-group"}function ls(t){return t.layer.type!=="subtype-group"}function cs(t){return t.layer.type==="subtype-sublayer"}function us(t,e){const n=new An({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:e?.distance??G.distance,touchSensitivityMultiplier:e?.touchSensitivityMultiplier??G.touchSensitivityMultiplier});return{...le(()=>t.map?.allLayers?.toArray()??[],i=>{n.featureSources=new fe(i.map(s=>new Vt({layer:s})))},ci),options:n}}var ve;function Fn(t,e,n){return C(t,e,n)}function C(t=0,e=0,n=0){return Ue(t,e,n)}function Fr(t){return t}function U(t,e,n){return Ue(t,e,n)}function Ee(t){const[e,n,i]=t;return t.length>3?[e,n,i,t[3]]:[e,n,i]}function ce(t){return t[3]=((t.length>3?t[3]:void 0)??ve.NONE)|ve.TARGET,t}function Cr(t){return!!(((t.length>3?t[3]:void 0)??ve.NONE)&ve.TARGET)}function $(t,e,{coordinateHelper:n,elevationInfo:i},s){return t?Te(n.vectorToDehydratedPoint(t,ds),e,i,s):null}function Te(t,e,n,i=C()){return i[0]=t.x,i[1]=t.y,i[2]=t.z??0,e==null||(e.type==="2d"?i[2]=0:i[2]=ui(e,t,n,x)??0),i}function Vr(t,e,n){return n?(mn(n,t[0],t[1],t[2],e),n):nt(t[0],t[1],t[2],e)}function sn(t,e,{z:n,m:i},s,r){const{spatialReference:a,elevationInfo:o}=s;let l;n==null&&i==null?l=void 0:e==null||e.type==="2d"?l=n??void 0:l=di(e,t,a,x,o)??0;const[c,u]=t;return r?mn(r,c,u,l,a):r=nt(c,u,l,a),i!=null&&(r.m=i,r.hasM=!0),r}function Ir(t,e,n,i,s=C()){const[r,a]=t;return s[0]=r,s[1]=a,t.length>3&&(s[3]=t[3]??ve.NONE),n?.type!=="3d"?(s[2]=e.value,s):(s[2]=hi(n,r,a,e.value,i,e.elevationInfo,x)??0,s)}(function(t){t[t.NONE=0]="NONE",t[t.TARGET=1]="TARGET"})(ve||(ve={}));const ds=nt(0,0,0,null);function It({start:t,end:e,type:n},i,s){const r=[],a=se(Fe,e,t),o=se(rt,t,i),l=Pe(a),c=2*Me(a,o),u=c*c-4*l*(Pe(o)-s*s);if(u===0){const d=-c/(2*l);(n===F.PLANE||d>=0)&&r.push(Re(k(),t,a,d))}else if(u>0){const d=Math.sqrt(u),f=(-c+d)/(2*l);(n===F.PLANE||f>=0)&&r.push(Re(k(),t,a,f));const g=(-c-d)/(2*l);(n===F.PLANE||g>=0)&&r.push(Re(k(),t,a,g))}return r}function Cn(t,e){const n=t.start,i=t.end,s=se(Fe,i,n),r=Z(ot,-s[1],s[0],0),a=e.start,o=e.end,l=A(jt,o,a),c=N(l,r),u=Z(Hn,n[0],n[1],0),d=A(qn,u,a),f=N(d,r),g=Se();if(Math.abs(c)<g)return[];const v=b(kn,a,l,f/c);if(e.type===T.RAY){const w=A(Lt,v,a);if(N(w,l)<-g)return[]}if(t.type===F.HALF_PLANE){const w=gi(rt,v,n);if(Me(w,s)<-g)return[]}return[de(v)]}function hs(t,e){return fs(Je(zt,e[2],t),e)}function Vn(t,e){return jn(Je(zt,0,t),Je(ws,0,e)).map(([i,s])=>He(i,s))}function In(t,e,n){return Ot(t,Je(zt,t[2],e),n)}function On(t,e,n,i=y()){const s=se(Fe,t,e),r=yi(s);return Re(i,e,s,r===0?1:n/r),i[2]=t[2],i}function Ot(t,{start:e,end:n,type:i},s=y()){const r=A(at,t,e),a=A(ot,n,e),o=N(r,a)/N(a,a);return b(s,e,a,i===T.RAY?Math.max(o,0):o)}const ps=(()=>{const t=y(),e=y(),n=y();return({start:i,end:s},{center:r,radius:a,normal:o,slicePlane:l})=>{const c=it(r,o,vs);if(S(St(c,i),0)&&S(St(c,s),0)){Sn(o,t,e);const d=(v,w)=>(Ae(n,w,r),$n(v,N(n,t),N(n,e)),v),f=ss({start:d(Fe,i),end:d(rt,s),type:T.LINE},vi,a),g=[];for(const[v,w]of f){const m=st(y(),r);b(m,m,t,v),b(m,m,e,w),l&&!ue(l,m)||g.push(m)}return g}const u=y();return En(c,i,s,u)?!S(_n(u,r),a)||l&&!ue(l,u)?[]:[u]:[]}})();function Dn({start:t,end:e,type:n},i,s){const r=[],a=Ae(at,e,t),o=se(rt,t,i),l=Pe(a),c=2*Me(a,o),u=c*c-4*l*(Pe(o)-s*s);if(u===0){const d=-c/(2*l);(n===T.LINE||d>=0)&&r.push(b(y(),t,a,d))}else if(u>0){const d=Math.sqrt(u),f=(-c+d)/(2*l);(n===T.LINE||f>=0)&&r.push(b(y(),t,a,f));const g=(-c-d)/(2*l);(n===T.LINE||g>=0)&&r.push(b(y(),t,a,g))}return r}function jn(t,e){const n=t.start,i=t.end,s=e.start,r=e.end,a=A(at,i,n),o=A(ot,r,s),l=A(jt,s,n),c=We(Hn,a,o);if(!S(N(l,c),0))return[];const u=Et(c);if(S(u,0))return[];const d=We(qn,l,o),f=N(d,c)/u,g=b(kn,n,a,f);if(t.type===T.RAY){const v=A(Lt,g,n);if(N(a,v)<-Se())return[]}if(e.type===T.RAY){const v=A(Lt,g,s);if(N(o,v)<-Se())return[]}return[de(g)]}function fs({start:t,end:e,type:n},i){const s=A(at,i,t),r=A(ot,e,t),a=We(jt,r,s),o=Et(a)/Et(r),l=Se();if(o<l)switch(n){case T.LINE:return[de(i)];case T.RAY:return N(r,s)<-l?[]:[de(i)]}return[]}function Dt(t,e,n,i){const[s,r]=t,[a,o]=n,l=a-s,c=o-r,u=l*l+c*c,d=Math.sqrt(u);if(d>e+i)return[];if(d<Math.abs(e-i))return[];if(S(d,0)&&S(e,i))return[];const f=(e*e-i*i+u)/(2*d),g=Math.sqrt(e*e-f*f),v=g*c/d,w=g*l/d,[m,V]=xn(Fe,t,n,f/d);return S(v,w)?[He(m,V)]:[He(m+v,V-w),He(m-v,V+w)]}function Je(t,e,{start:n,end:i,type:s}){return Z(t.start,n[0],n[1],e),Z(t.end,i[0],i[1],e),t.type=ys[s],t}function zn(t,e){return S(t[2],e[2])}function S(t,e){return pi(Math.abs(t-e),0,Se())}function gs(t,e){return e.filter(n=>ue(t,n))}function ue(t,e){return fi(t,e)}var F;(function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"})(F||(F={}));const ys={[F.PLANE]:T.LINE,[F.HALF_PLANE]:T.RAY},Fe=k(),rt=k(),at=y(),ot=y(),jt=y(),Hn=y(),qn=y(),kn=y(),Lt=y(),vs=I(),zt={start:y(),end:y(),type:T.LINE},ws={start:y(),end:y(),type:T.LINE};class D{intersect(e){return J(this,e)}closestPoints(e){return[this.closestTo(e)]}}class $e extends D{constructor(e){super(),this.point=e}equals(e){return this===e||j(e)&&_(this.point,e.point)}closestTo(){return Ee(this.point)}}class Ht extends D{constructor(e,n,i){super(),this.start=e,this.end=n,this.lineLike={start:e,end:n,type:i}}equals(e){return this===e||Y(e)&&this.lineLike.type===e.lineLike.type&&_(this.start,e.start)&&_(this.end,e.end)}closestTo(e){const n=C();return Ot(e,this.lineLike,n),n}}class qt extends Ht{constructor(e,n){super(e,n,T.LINE)}}class ms extends Ht{constructor(e,n){super(e,n,T.RAY)}}class Gn extends D{constructor(e){super(),this.constraints=e}equals(e){return this===e||bt(e)&&mi(this.constraints,e.constraints,(n,i)=>n.equals(i))}closestTo(e){let n,i=1/0;for(const s of this.constraints){const r=s.closestTo(e),a=Ye(e,r);a<i&&(i=a,n=r)}return Ee(n??e)}closestPoints(e){return this.constraints.flatMap(n=>n===this?[]:n.closestPoints(e))}}class Zn extends D{constructor(e,n){super(),this.center=e,this.radius=n}equals(e){return this===e||K(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const n=C();return On(e,this.center,this.radius,n),n}}class kt extends D{constructor(e,n){super(),this.center=e,this.radius=n}equals(e){return this===e||ee(e)&&_(this.center,e.center)&&this.radius===e.radius}closestTo(e){const n=C();return On(e,this.center,this.radius,n),n[2]=this.center[2],n}asCircle(){return new Gt(Ee(this.center),this.radius,U(0,0,1))}}class Gt extends D{constructor(e,n,i,s=void 0){super(),this.center=e,this.radius=n,this.normal=i,this.slicePlane=s}equals(e){return this===e||ae(e)&&_(this.center,e.center)&&_(this.normal,e.normal)&&this.radius===e.radius}closestTo(e){const{center:n,radius:i}=this;Ln(this.getPlane(Ss),e,pt);const s=A(pt,pt,n),r=Si(s);if(S(r,0))return Ee(e);const a=i/Math.sqrt(r),o=C();b(o,n,s,a);const{slicePlane:l}=this;return l&&!ue(l,o)?Ut(l,this)?.closestTo(e)??Ee(e):o}getPlane(e=I()){return it(this.center,this.normal,e)}}const pt=y(),Ss=I();class Es extends D{constructor(e){super(),this.z=e}equals(e){return this===e||Q(e)&&this.z===e.z}closestTo(e){return U(e[0],e[1],this.z)}getPlane(e=I()){return Z(rn,0,0,this.z),it(rn,Ri,e)}}const rn=y();class Zt extends D{constructor(e,n,i){super(),this.start=e,this.end=n,this.planeLike={start:e,end:n,type:i}}equals(e){return this===e||B(e)&&this.planeLike.type===e.planeLike.type&&_(this.start,e.start)&&_(this.end,e.end)}closestTo(e){const n=C();return In(e,this.planeLike,n),n}closestEndTo(e){const{start:n,end:i}=this.planeLike;return Math.sign(Me(se(_s,i,n),se(xs,e,n)))>0?this.end:this.start}getPlane(e=I()){const n=st(an,this.end);return n[2]+=1,Pi(this.start,this.end,n,e)}getSlicePlane(e=I()){const{start:n,end:i,type:s}=this.planeLike;if(s===F.PLANE)return;const r=Z(an,n[0],n[1],0),a=Z(on,i[0],i[1],0),o=Ae(on,a,r);return it(r,o,e),e}}const _s=k(),xs=k(),an=y(),on=y();class Un extends Zt{constructor(e,n){super(e,n,F.HALF_PLANE)}}class Wn extends Zt{constructor(e,n){super(e,n,F.PLANE)}}class $s extends D{constructor(e,n){super(),this.sphere=Ni(e,n)}equals(e){return this===e||te(e)&&Mi(this.sphere,e.sphere)}closestTo(e){const n=C();return Ai(this.sphere,e,n),n}get center(){return Fi(this.sphere)}get radius(){return this.sphere[3]}}class Yn extends D{constructor(e,n,i){super(),this.start=e,this.end=n,this.getZ=i,this.planeLike={start:e,end:n,type:F.PLANE}}equals(e){return this===e||Qe(e)&&_(this.start,e.start)&&_(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Ns(this,e)}addIfOnTheGround(e,n){for(const i of n){const s=this.getZ(i[0],i[1])??0;S(i[2],s)&&(i[2]=s,e.push(i))}}}class Ls extends D{constructor(e,n,i){super(),this._x=e,this._y=n,this._z=i}equals(e){return this===e||Us(e)&&this._x===e._x&&this._y===e._y&&this._z===e._z}closestTo([e,n,i]){return Fn(this._x??e,this._y??n,this._z??i)}}class bs extends D{constructor(e,n,i,s,r){super(),this._origin=e,this._spatialReference=n,this._distanceMeters=i,this._elevationMeters=s,this._directionDegrees=r}equals(e){return this===e||Zs(e)&&Qt(this._origin,e._origin)&&this._spatialReference===e._spatialReference&&this._distanceMeters===e._distanceMeters&&this._elevationMeters===e._elevationMeters&&this._directionDegrees===e._directionDegrees}closestTo([e,n,i]){return $n(be,e,n),Qt(be,this._origin)||this._applyDirectionAndDistance(be),Fn(be[0],be[1],this._elevationMeters??i)}_applyDirectionAndDistance(e){if(this._directionDegrees!=null&&this._distanceMeters!=null)Xe(e,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(this._directionDegrees!=null)Rs(e,this._origin,this._directionDegrees,e,this._spatialReference);else if(this._distanceMeters!=null){const{azimuth:n}=Ft(Ts,this._origin,e,this._spatialReference);Xe(e,this._origin,n??0,this._distanceMeters,this._spatialReference)}}}const be=[0,0],Ts=new Ct;function Rs(t,e,n,i,s){let{azimuth:r,distance:a}=Ft(Ps,e,i,s);r??=0;let o=a*Math.cos((r-n)*Ci);o=Math.max(0,o),Xe(t,e,n,o,s)}const Ps=new Ct;function Ns(t,e){const n=C();return In(e,t.planeLike,n),n[2]=t.getZ(n[0],n[1])??Kn,n}function J(t,e){if(bt(t)){const n=[];for(const i of t.constraints){const s=i.intersect(e);s&&n.push(s)}return Wt(n)}if(bt(e))return J(e,t);if(Qe(t))return ln(t,e);if(Qe(e))return ln(e,t);if(j(t)){const{point:n}=t;if(j(e))return _(n,e.point)?t:void 0;const i=e.closestTo(n);return $i(i,n)?t:void 0}if(Y(t)){if(j(e))return J(e,t);if(Y(e))return q(jn(t.lineLike,e.lineLike));if(Q(e))return Ms(t,e);if(B(e))return q(Cn(e.planeLike,t.lineLike));if(K(e))return q(Dn(t.lineLike,e.center,e.radius));if(ae(e))return q(ps(t.lineLike,e));if(ee(e))return As(t,e);if(te(e))return Fs(t,e)}else if(Q(t)){if(j(e)||Y(e))return J(e,t);if(Q(e))return Cs(t,e);if(B(e))return Vs(t,e);if(K(e))return Is(t,e);if(ae(e))return Ds(t,e);if(ee(e))return Os(t,e);if(te(e))return js(t,e)}else if(B(t)){if(j(e)||Y(e)||Q(e))return J(e,t);if(B(e))return ft(Vn(t.planeLike,e.planeLike));if(K(e))return ft(It(t.planeLike,e.center,e.radius));if(ae(e))return Hs(t,e);if(ee(e))return zs(t,e);if(te(e))return qs(t,e)}else if(K(t)){if(j(e)||Y(e)||Q(e)||B(e))return J(e,t);if(K(e))return ft(Dt(t.center,t.radius,e.center,e.radius));if(ae(e))return void 0;if(ee(e))return ks(t,e);if(te(e))return void 0}else if(ae(t)){if(j(e)||Y(e)||Q(e)||B(e)||K(e))return J(e,t);if(ae(e))return void 0;if(ee(e))return e.asCircle(),void 0;if(te(e))return void 0}else if(ee(t)){if(j(e)||Y(e)||Q(e)||B(e)||K(e)||ae(e))return J(e,t);if(ee(e))return Gs(e,t);if(te(e))return void 0}else if(te(t)){if(j(e)||Y(e)||Q(e)||B(e)||K(e)||ee(e))return J(e,t);if(te(e))return void 0}}const Ms=(()=>{const t=I();return(e,n)=>{const{start:i,end:s}=e;if(zn(i,s)&&S(i[2],n.z))return e;const r=C();return En(n.getPlane(t),i,s,r)?new $e(r):void 0}})();function As({lineLike:t},{center:e,radius:n}){const i=e[2];return q(Dn(t,e,n).filter(s=>S(s[2],i)))}function Fs({lineLike:t},{sphere:e}){return q(Li(e,t.start,t.end))}const Ut=(()=>{const t=bi(),e=y(),n=y();return(i,s,r)=>{const{normal:a,center:o,radius:l}=s;Sn(a,e,n);const c=bn(i),u=l*N(c,e),d=l*N(c,n);Ei(t,o[0],o[1],o[2],1);const f=_i(i,t),g=Math.hypot(u,d),v=S(g,0);if(S(St(i,o),0)){if(v)return s;if(S(l,0))return!r||ue(r,o)?new $e(Ee(o)):void 0;We(e,c,a),xi(e,e);const ut=new Array,Oe=de(o);b(Oe,Oe,e,l),r&&!ue(r,Oe)||ut.push(Oe);const De=de(o);return b(De,De,e,-l),r&&!ue(r,De)||ut.push(De),q(ut)}if(v)return;const w=-f/g;if(Math.abs(w)>1||S(w,1))return;const m=Math.atan(u/d),V=Ti(w)-m,Jt=Math.PI-V,Ce=new Array,Ve=y();b(Ve,o,e,l*Math.cos(V)),b(Ve,Ve,n,l*Math.sin(V)),Ce.push(Ve);const Ie=y();return b(Ie,o,e,l*Math.cos(Jt)),b(Ie,Ie,n,l*Math.sin(Jt)),Ce.push(Ie),q(r?gs(r,Ce):Ce)}})();function Cs(t,e){return S(t.z,e.z)?t:void 0}function Vs({z:t},{planeLike:e}){const[n,i]=e.start,[s,r]=e.end,a=U(n,i,t),o=U(s,r,t);return e.type===F.PLANE?new qt(a,o):new ms(a,o)}function Is(t,e){const[n,i]=e.center;return new kt(U(n,i,t.z),e.radius)}function Os(t,e){return S(e.center[2],t.z)?e:void 0}const Ds=(()=>{const t=I();return(e,n)=>Ut(e.getPlane(t),n,n.slicePlane)})();function js(t,{center:e,radius:n}){const i=Math.abs(e[2]-t.z);if(i>n&&!S(i,n))return;const s=U(e[0],e[1],t.z),r=Math.sqrt(n**2-i**2);return S(r,0)?void 0:new kt(s,r)}const zs=(()=>{const t=I();return(e,{center:n,radius:i})=>{const s=It(e.planeLike,n,i),r=n[2];e.getSlicePlane(t);const a=new Array;for(const[o,l]of s){const c=[o,l,r];ue(t,c)&&a.push(c)}return q(a)}})(),Hs=(()=>{const t=I(),e=I();return(n,i)=>Ut(n.getPlane(t),i,n.getSlicePlane(e))})(),qs=(()=>{const t=I();return(e,{center:n,radius:i})=>{const s=e.getPlane(t),r=wi(s,n),a=Math.abs(r);if(a>i&&!S(a,i))return;const o=Math.sqrt(i**2-r**2);if(S(o,0)){const u=C();return Ln(s,n,u),new $e(u)}const l=C(),c=de(bn(s));return b(l,n,c,r),new Gt(l,o,c,e.getSlicePlane())}})();function ks(t,e){const n=ge(t.center,e.center);return S(n,0)&&S(t.radius,e.radius)?e:Bn(Dt(t.center,t.radius,e.center,e.radius),e.center[2])}function Gs(t,e){if(!zn(t.center,e.center))return;const n=ge(t.center,e.center);return S(n,0)&&S(t.radius,e.radius)?t:Bn(Dt(t.center,t.radius,e.center,e.radius),t.center[2])}function ln(t,e){const{planeLike:n,getZ:i}=t,s=new Array;if(j(e))t.addIfOnTheGround(s,hs(n,e.point));else if(Y(e))t.addIfOnTheGround(s,Cn(n,e.lineLike));else if(K(e))for(const[r,a]of It(n,e.center,e.radius)){const o=i(r,a);o!=null&&s.push(Ue(r,a,o))}else if(B(e)||Qe(e))for(const[r,a]of Vn(n,e.planeLike)){const o=i(r,a)??Kn;s.push(Ue(r,a,o))}return q(s)}function ft(t){return Wt(t.map(([e,n])=>{const i=U(e,n,0),s=U(e,n,1);return new qt(i,s)}))}function q(t){return Wt(t.map(e=>e?new $e(e):void 0))}function Bn(t,e){return q(t.map(([n,i])=>[n,i,e]))}function Wt(t){if(t.length!==0)return t.length===1?t[0]??void 0:new Gn(t.filter(Tn))}function bt(t){return t instanceof Gn}function j(t){return t instanceof $e}function Y(t){return t instanceof Ht}function Q(t){return t instanceof Es}function B(t){return t instanceof Zt}function K(t){return t instanceof Zn}function ee(t){return t instanceof kt}function ae(t){return t instanceof Gt}function te(t){return t instanceof $s}function Qe(t){return t instanceof Yn}function Zs(t){return t instanceof bs}function Us(t){return t instanceof Ls}const Kn=0;function we(t,e){const n=t.x-e.x,i=t.y-e.y;return n*n+i*i}function Ws(t,e){return Math.sqrt(we(t,e))}function Yt(t,e){e.sort((n,i)=>Ye(n.targetPoint,t)-Ye(i.targetPoint,t))}var O;function Or({point:t,distance:e,returnEdge:n,vertexMode:i,coordinateHelper:{spatialReference:s},filter:r},a,o){return o=o!=null?o.clone():new Vi({where:"1=1"}),r&&(o.geometry=r.geometry,o.distance=r.distance,o.spatialRelationship=r.spatialRelationship,o.where=Pt(o.where,r.where),o.timeExtent=Ii(o.timeExtent,r.timeExtent),o.objectIds=Ys(o.objectIds,r.objectIds)),{point:nt(t[0],t[1],t[2],s.toJSON()),mode:a,distance:e,returnEdge:n,vertexMode:i,query:o.toJSON()}}function Ys(t,e){return t||e?e?t?Array.from(Oi(new Set(t),new Set(e))):e:t:null}function et(t,e,n){return{left:$(t.leftVertex.pos,e,n),right:$(t.rightVertex.pos,e,n)}}function Dr(t){return t.createQuery()}(function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(O||(O={}));const cn=Symbol("snapping-toggle");function jr(t,e=()=>{}){const n=le(()=>({view:t.view,snappingOptions:t.snappingOptions}),({view:i,snappingOptions:s})=>{if(t.removeHandles(cn),!i||!s)return;const r=Di.TOOL,a=[i.on("key-down",o=>{o.key!==tn.toggle||o.repeat||(s.enabledToggled=!0,e())},r),i.on("key-up",o=>{o.key===tn.toggle&&(s.enabledToggled=!1,e())},r),i.on("pointer-move",o=>{const l=o.native.ctrlKey;s.enabledToggled!==l&&(s.enabledToggled=l,e())},r)];t.addHandles(a,cn)},Be);t.addHandles(n)}function un(t){return os(t)&&"utilityNetworks"in t&&!!t.utilityNetworks?.length}let M=class extends xe{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){return this.view?.allLayerViews?.find(e=>e.layer===this.layer)}get valid(){const{_valid:e,snappingSource:n,layer:i}=this;return!(!n||!i)&&e}get subtypeFilter(){const{layer:e,snappingSource:n}=this;if(!je(e)||!e.subtypes?.length||!n)return{mode:"not-in-use",filter:null};const i=n.layerSource.sublayerSources.filter(r=>r.enabled&&r.layer.visible&&ji(this.view?.scale,r.layer.effectiveScaleRange.minScale,r.layer.effectiveScaleRange.maxScale)).map(r=>r.layer.subtypeCode);if(!i.length)return{mode:"none-visible",filter:null};if(i.length===e.subtypes.length)return{mode:"all-visible",filter:null};const s=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return i.length===1?{mode:"in-use",filter:`${s} = ${i.getItemAt(0)}`}:{mode:"in-use",filter:`${s} IN (${i.join(", ")})`}}get floorFilter(){const{view:e,layer:n}=this;return e&&n?as({view:e,layer:n}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:n}=this;if("refresh"in e){const i=e;this.addHandles(i.on("refresh",()=>n.refresh()))}this.loadRules(),this.addHandles([le(()=>n.updating,i=>n.layerSource.updating=i,Be),le(()=>n.availability,i=>n.layerSource.availability=i,Be)])}getFetchCandidatesParameters(e,n,i){if(!this.valid)return[];const{layer:s,layerView:r,floorFilter:a,rulesTable:o,subtypeFilter:l}=this,c={distance:i,mode:this.view?.type??"2d",point:e,coordinateHelper:n.coordinateHelper,...Bs(),filter:r&&"filter"in r?r.filter:null};if(a&&(c.filter=gt(c.filter,a)),l.mode!=="not-in-use"&&l.mode!=="all-visible"){if(l.mode==="none-visible")return[];c.filter?c.filter.where=Pt(c.filter.where,l.mode):c.filter=new qe({where:l.filter})}if(!this.attributeRulesEnabled)return[c];const u=n.feature,d=u?.sourceLayer?.type==="subtype-sublayer"?u.sourceLayer.parent:u?.sourceLayer;if(o&&u&&un(this.view?.map)&&(dt(s)||je(s))&&s.layerId&&(dt(d)||je(d))&&this.view.map.utilityNetworks?.find(f=>f.isUtilityLayer(d))){if(o.loadStatus!=="loaded")return[];const f=[],g=s.layerId,v=o.getFeatureSQL(d,u)?.[g];if(!v)return[];const w=v.anyVertex;let m=v.endVertex;return m&&w&&m===w&&(m=""),m&&f.push({...c,returnEdge:!1,vertexMode:"ends",filter:gt(c.filter,m)}),w&&f.push({...c,returnEdge:!1,vertexMode:"all",filter:gt(c.filter,w)}),f}return[c]}async loadRules(){this._valid=null;const{layer:e,view:n,attributeRulesEnabled:i}=this;if(i&&e&&n&&un(n?.map)&&(dt(e)||je(e)))try{await Promise.allSettled(n.map.utilityNetworks?.map(r=>r.load())??[]);const s=n.map.utilityNetworks?.find(r=>r.isUtilityLayer(e));s&&(this.rulesTable=await s.getRulesTable(),await this.rulesTable?.load())}catch{return this._valid=!1,void wn.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function Bs(){return{returnEdge:!0,vertexMode:"all"}}function gt(t,e){return t==null?new qe({where:e}):t.where?new qe({where:Pt(t.where,e)}):new qe({where:e})}h([p({constructOnly:!0})],M.prototype,"layer",void 0),h([p({constructOnly:!0})],M.prototype,"snappingSource",void 0),h([p({constructOnly:!0})],M.prototype,"view",void 0),h([p({value:!1})],M.prototype,"attributeRulesEnabled",null),h([p()],M.prototype,"layerView",null),h([p()],M.prototype,"rulesTable",void 0),h([p()],M.prototype,"valid",null),h([p()],M.prototype,"subtypeFilter",null),h([p()],M.prototype,"floorFilter",null),h([p()],M.prototype,"_valid",void 0),M=h([he("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],M);var L;(function(t){t[t.FEATURE=1]="FEATURE",t[t.SELF=2]="SELF",t[t.ALL=3]="ALL"})(L||(L={}));class Le{constructor(e,n,i,s){this.targetPoint=e,this.constraint=n,this.isDraped=i,this.domain=s}}let Bt=class extends Le{constructor({targetPoint:e,objectId:n,constraint:i,isDraped:s}){super(e,i,s,L.FEATURE),this.objectId=n}},lt=class{constructor(e,n){this.isDraped=e,this.domain=n}},X=class Xn extends lt{constructor(e,n,i,s,r=L.ALL,a=!0,o=!0){super(s,r),this.type=e,this.lineStart=n,this.lineEnd=i,this.fadeLeft=a,this.fadeRight=o}equals(e){return e instanceof Xn&&this.type===e.type&&_(this.lineStart,e.lineStart)&&_(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return _n(this.lineStart,this.lineEnd)}},Jn=class extends Bt{constructor(e){super({...e,isDraped:!0,constraint:new Yn(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new X(O.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Qn=class extends Bt{constructor(e){super({...e,constraint:new qt(e.edgeStart,e.edgeEnd)})}get hints(){return[new X(O.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},ei=class ti extends lt{constructor(e,n,i,s,r=L.ALL){super(s,r),this.previousVertex=e,this.centerVertex=n,this.nextVertex=i}equals(e){return e instanceof ti&&_(this.previousVertex,e.previousVertex)&&_(this.centerVertex,e.centerVertex)&&_(this.nextVertex,e.nextVertex)}};class Kt extends Le{constructor({targetPoint:e,constraint:n,previousVertex:i,otherVertex:s,otherVertexType:r,isDraped:a,selfSnappingType:o,objectId:l,domain:c}){super(e,n,a,c??L.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.selfSnappingType=o??oe.None,this.objectId=l??null}get hints(){const e=this.previousVertex,n=this.otherVertexType===_e.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===_e.CENTER?this.targetPoint:this.otherVertex;return[new X(O.TARGET,n,i,this.isDraped,this.domain),new X(O.REFERENCE,e,n,this.isDraped,this.domain),new ei(this.previousVertex,n,i,this.isDraped,this.domain)]}}var _e,oe;(function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"})(_e||(_e={})),function(t){t[t.None=0]="None",t[t.LastVertex=1]="LastVertex",t[t.FirstVertex=2]="FirstVertex",t[t.ExistingEdge=3]="ExistingEdge"}(oe||(oe={}));let ne=class extends xe{get updating(){return this._snappingSources.some(e=>e?.valid==null||e.valid===!0&&e.snappingSource?.updating===!0)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=L.FEATURE,this._updatingHandles=new zi,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=Hi(()=>this.options?._effectiveFeatureSources,(n,i)=>this._createSourceInfo(n,i));this._snappingSources=e,this.addHandles([qi(e),le(()=>({rulesEnabled:!!this.options?.attributeRulesEnabled,sources:this._snappingSources.filter(Tn)}),({rulesEnabled:n,sources:i})=>{for(const s of i)s.attributeRulesEnabled=n},_t)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,n,i,s){if(!(n&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,i);for(const l of this._snappingSources){if(!l?.valid||!l.snappingSource?.layerSource?.enabled||l.layerView?.suspended)continue;const c=l.getFetchCandidatesParameters(e,i,a);for(const u of c)r.push(l.snappingSource.fetchCandidates(u,s).then(d=>d.filter(f=>!this._candidateIsExcluded(l.snappingSource,f,i.excludeFeature))))}const o=(await ki(r)).flat();return this._addRightAngleCandidates(o,e,a,i),ht(s),Yt(e,o),o}_addRightAngleCandidates(e,n,i,s){const r=s.vertexHandle!=null?s.vertexHandle.rightEdge?.rightVertex?.pos:s.editGeometryOperations!=null&&s.editGeometryOperations.data.type==="polygon"?s.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,a=s.vertexHandle!=null?s.vertexHandle.leftEdge?.leftVertex?.pos:s.editGeometryOperations!=null?s.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:o}=this,l=$(r,o,s),c=$(a,o,s),u=e.length;for(let d=0;d<u;d++)this._addRightAngleCandidate(e[d],c,n,i,e),this._addRightAngleCandidate(e[d],l,n,i,e)}_addRightAngleCandidate(e,n,i,s,r){if(n==null||!Ks(e))return;const a=e.constraint.closestTo(n),o=(a[0]-i[0])/s.x,l=(a[1]-i[1])/s.y,{start:c,end:u}=e.constraint;if(o*o+l*l<=1){const d=ge(a,c)>ge(a,u)?c:u,f=new Kt({targetPoint:ce(a),otherVertex:n,otherVertexType:_e.NEXT,previousVertex:d,constraint:new Un(n,a),objectId:e.objectId,isDraped:e.isDraped,domain:L.FEATURE});r.push(f)}}_computeScreenSizeDistanceParameters(e,n){let i=this.options!=null?this.options.distance*(n.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,n)}_computeScreenSizeDistanceParameters3D(e,n,i,s){const{spatialReference:r}=s;i.renderCoordsHelper.toRenderCoords(e,r,dn);const a=i.state.camera.computeScreenPixelSizeAt(dn),o=a*i.renderCoordsHelper.unitInMeters,l=o/Rn(r),c=o/Gi(r),u=n*l,d=n*c,f=P(e,r,x,i),g=f?yt(f,e,l,0,0,i,s):0,v=f?yt(f,e,0,l,0,i,s):0,w=f?yt(f,e,0,0,c,i,s):0;return{x:g===0?0:u/g,y:v===0?0:u/v,z:w===0?0:d/w,distance:a*n}}_candidateIsExcluded(e,n,i){if(i==null)return!1;const s=this._getCandidateObjectId(n);if(s==null)return!1;const r=e.layerSource.layer;return r.type==="graphics"?i.uid===s:i.sourceLayer===r&&!(!i.attributes||!("objectIdField"in r))&&i.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof Bt?e.objectId:null}async _createSourceInfo(e,n){const i=e.layer;i.loaded||(await i.load(),ht(n));const{view:s}=this,r=await this._createFeatureSnappingSourceType(e);return ht(n),new M(r==null?{}:{snappingSource:r,view:s,layer:i})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:n}=this;return n==null||n.type!=="3d"?null:new(await this._getSourceModule("scene")).SceneLayerSnappingSource({layerSource:e,view:n})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":return new(await this._getSourceModule("featureService")).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return e.layer.geometryType==="mesh"?null:new(await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await this._getSourceModule("graphics")).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await this._getSourceModule("notes")).GraphicsSnappingSource({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const n=this._sourceModules[e];if(n.loader==null){const i=this._loadSourceModule(e),s={module:null,loader:i};this._sourceModules[e]=s;const r=await i,a={module:r,loader:i};return this._sourceModules[e]=a,r}return n.module==null?n.loader:n.module}_loadSourceModule(e){const n=this._updatingHandles;switch(e){case"featureService":return n.addPromise(ze(()=>import("./FeatureServiceSnappingSource-c11b7d49.js"),["./FeatureServiceSnappingSource-c11b7d49.js","./index-ee8e5ecc.js","./index-a86c5357.css","./memoize-3e55df82.js","./queryEngineUtils-ac21a561.js","./VertexSnappingCandidate-95641230.js","./PointSnappingHint-f1f4fe9c.js","./TileTreeDebugger-11be5ef8.js","./WorkerHandle-5bfc3acb.js","./geodesicLengthMeasurementUtils-a43c4a81.js","./geometryEngine-a2ba786d.js","./geometryEngineBase-bdf57d0e.js","./hydrated-9151ecd7.js","./geometry2dUtils-bb0dcbdc.js","./floorFilterUtils-73949d2d.js","./keybindings-d8b58741.js"],import.meta.url));case"featureCollection":return n.addPromise(ze(()=>import("./FeatureCollectionSnappingSource-e31a7dca.js"),["./FeatureCollectionSnappingSource-e31a7dca.js","./index-ee8e5ecc.js","./index-a86c5357.css","./memoize-3e55df82.js","./queryEngineUtils-ac21a561.js","./VertexSnappingCandidate-95641230.js","./PointSnappingHint-f1f4fe9c.js","./symbologySnappingCandidates-29095c06.js","./geodesicLengthMeasurementUtils-a43c4a81.js","./geometryEngine-a2ba786d.js","./geometryEngineBase-bdf57d0e.js","./hydrated-9151ecd7.js","./geometry2dUtils-bb0dcbdc.js","./floorFilterUtils-73949d2d.js","./keybindings-d8b58741.js"],import.meta.url));case"graphics":case"notes":return n.addPromise(ze(()=>import("./GraphicsSnappingSource-1dcad001.js"),["./GraphicsSnappingSource-1dcad001.js","./index-ee8e5ecc.js","./index-a86c5357.css","./memoize-3e55df82.js","./normalizeUtilsSync-1442551d.js","./normalizeUtilsCommon-2270a178.js","./FeatureStore-2f56759a.js","./BoundsStore-3451b635.js","./PooledRBush-9e9eeb23.js","./quickselect-8e85fa0f.js","./QueryEngine-5264404e.js","./normalizeUtils-d9b14f9e.js","./WhereClause-7b39bf18.js","./TimeOnly-6ac4fb3b.js","./json-48e3ea08.js","./utils-ade942ec.js","./utils-11d55532.js","./utils-47ac37f9.js","./ClassBreaksDefinition-43c97c7c.js","./optimizedFeatureQueryEngineAdapter-5efe58be.js","./queryEngineUtils-ac21a561.js","./VertexSnappingCandidate-95641230.js","./PointSnappingHint-f1f4fe9c.js","./symbologySnappingCandidates-29095c06.js","./geodesicLengthMeasurementUtils-a43c4a81.js","./geometryEngine-a2ba786d.js","./geometryEngineBase-bdf57d0e.js","./hydrated-9151ecd7.js","./geometry2dUtils-bb0dcbdc.js","./floorFilterUtils-73949d2d.js","./keybindings-d8b58741.js"],import.meta.url));case"scene":return n.addPromise(ze(()=>import("./SceneLayerSnappingSource-07dfc9c3.js"),["./SceneLayerSnappingSource-07dfc9c3.js","./index-ee8e5ecc.js","./index-a86c5357.css","./EdgeWorkerHandle-65650c09.js","./WorkerHandle-5bfc3acb.js","./workerHelper-64b9eaa8.js","./VertexSnappingCandidate-95641230.js","./PointSnappingHint-f1f4fe9c.js","./geodesicLengthMeasurementUtils-a43c4a81.js","./geometryEngine-a2ba786d.js","./geometryEngineBase-bdf57d0e.js","./hydrated-9151ecd7.js","./geometry2dUtils-bb0dcbdc.js","./floorFilterUtils-73949d2d.js","./keybindings-d8b58741.js"],import.meta.url))}}get test(){}};function Ks(t){return(t instanceof Qn||t instanceof Jn)&&!Xs(t)}function Xs({constraint:{start:t,end:e}}){const n=Ye(t,e),i=ge(t,e);return n<Se()||i/n<Qs}function yt(t,e,n,i,s,r,{spatialReference:a}){const o=st(Js,e);o[0]+=n,o[1]+=i,o[2]+=s;const l=P(o,a,x,r);return l?Ws(l,t):1/0}h([p({constructOnly:!0})],ne.prototype,"spatialReference",void 0),h([p({constructOnly:!0})],ne.prototype,"view",void 0),h([p()],ne.prototype,"options",void 0),h([p({readOnly:!0})],ne.prototype,"updating",null),h([p()],ne.prototype,"_snappingSources",void 0),ne=h([he("esri.views.interactive.snapping.FeatureSnappingEngine")],ne);const dn=y(),Js=y(),Qs=1e-4;class ct{constructor(e,n){this.view=e,this.options=n,this.squaredShortLineThreshold=G.shortLineThreshold*G.shortLineThreshold}snap(e,n){return n.vertexHandle!=null?n.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,n):this.snapNewVertex(e,n)}edgeExceedsShortLineThreshold(e,n){return this.exceedsShortLineThreshold($(e.leftVertex.pos,this.view,n),$(e.rightVertex.pos,this.view,n),n)}exceedsShortLineThreshold(e,n,{spatialReference:i}){return this.squaredShortLineThreshold===0||we(P(n,i,x,this.view),P(e,i,x,this.view))>this.squaredShortLineThreshold}isVertical(e,n,{spatialReference:i}){const s=Rn(i);return Nt(e,n)*s<G.verticalLineThresholdMeters}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:n}=this.options,i=e*n;return i*i}}let ni=class extends Le{constructor({lineStart:e,lineEnd:n,targetPoint:i,isDraped:s}){super(i,new Wn(e,n),s,L.SELF),this._referenceLineHint=new X(O.REFERENCE_EXTENSION,e,n,s,this.domain)}get hints(){return[this._referenceLineHint,new X(O.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}};var z;function er(t,e){if(t==null||e==null)return;const n=Tt(t,e);return n!=null?ye(n,"radians","geographic"):void 0}(function(t){t.Absolute="absolute",t.Relative="relative",t.RelativeBilateral="relative-bilateral"})(z||(z={}));const Tt=(()=>{const t=y(),e=y();return(n,i)=>(Z(t,n.x,n.y,n.z??0),Z(e,i.x,i.y,i.z??0),Ne(t,e,n.spatialReference,i.spatialReference))})(),Ne=(()=>{const t=k(),e=y(),n=y();return(i,s,r,a)=>{if(_(i,s))return;const o=xt(r),l=xt(a);if(o&&l&&Zi(o,l)&&Ke(i,r,e,o)&&Ke(s,a,n,l)){const{azimuth:u}=Ft(nr,e,n,o);return u!=null?Mt(u,"degrees","radians"):void 0}t[0]=s[0]-i[0],t[1]=s[1]-i[1];let c=Ui(Wi,t);return t[0]<0&&(c=ir-c),c}})();function Wr(t,e,n,i=z.Absolute){if(e&&n)switch(i){case z.Absolute:return er(e,n);case z.Relative:return pn(hn(t,e,n),z.Relative);case z.RelativeBilateral:return pn(hn(t,e,n),z.RelativeBilateral)}}function hn(t,e,n){if(!t||!e||!n)return;const i=Tt(t,e),s=Tt(e,n);return i!=null&&s!=null?ye(s-i,"radians","geographic"):void 0}function pn(t,e){if(t!=null)switch(e){case z.Absolute:return tr(t);case z.Relative:{const n=tt(t);let i=fn.normalize(n,0,!0);return i===-180&&(i=180),ye(i,"degrees","geographic")}case z.RelativeBilateral:{const n=tt(t),i=Math.abs(fn.normalize(n,0,!0));return ye(i,"degrees","geographic")}}}function tr(t){const e=tt(t),n=sr.normalize(e,0,!0);return ye(n,"degrees","geographic")}const ii=(()=>{const t=y();return(e,n,i,s,r,a="geodesic")=>{st(t,n);const o=tt(r);if(a==="geodesic"){const g=xt(i);if(g&&Ke(t,i,t,g))return Xe(e,t,o,s,g),e[2]=n[2],!!Ke(e,g,e,i)}const l=At(o,"geographic","arithmetic"),c=Mt(l,"degrees","radians"),u=n[0]+s*Math.cos(c),d=n[1]+s*Math.sin(c),f=n[2];return Z(e,u,d,f),!0}})();function tt(t){if(t!=null)return At(si(t),t.rotationType,"geographic")}function Yr(t){if(t!=null)return At(si(t),t.rotationType,"arithmetic")}function si(t){return Mt(t.value,t.unit,"degrees")}const nr=new Ct,ir=2*Math.PI,sr=Yi,fn=new Bi(-180,180);class rr extends ct{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=n,o=P(e,a,x,this.view),{view:l}=this,c=i.edges[s-1];let u=c;do{if(this.edgeExceedsShortLineThreshold(u,n)){const d=et(u,l,n);this._processCandidateProposal(d.left,d.right,e,o,n,r)}u=u.leftVertex.leftEdge}while(u&&u!==c);return r}snapExistingVertex(e,n){const i=[],s=n.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:a}=this,{spatialReference:o}=n,l=P(e,o,x,a),c=s.leftEdge,u=s.rightEdge;c&&u&&this.edgeExceedsShortLineThreshold(c,n)&&this.edgeExceedsShortLineThreshold(u,n)&&this._processCandidateProposal($(c.leftVertex.pos,a,n),$(u.rightVertex.pos,a,n),e,l,n,i);const d=r.edges[0];let f=d;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,n)){const g=et(f,a,n);this._processCandidateProposal(g.left,g.right,e,l,n,i)}f=f.rightVertex.rightEdge}while(f&&f!==d);return i}_processCandidateProposal(e,n,i,s,r,a){const{spatialReference:o,pointer:l}=r,c=y();ar(c,e,n,i,r);const u=ce(c);we(s,P(u,o,x,this.view))<this.squaredProximityThreshold(l)&&a.push(new ni({lineStart:e,lineEnd:n,targetPoint:u,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}function ar(t,e,n,i,s){or(t,e,n,i,s)||lr(t,i,e,n)}function or(t,e,n,i,{spatialReference:s}){const r=Ne(e,n,s,s);if(r==null)return!1;const a=Ne(n,i,s,s);if(a==null)return!1;const o=Mn(n,i,s);if(o==null)return!1;const l=Math.abs(Ki.shortestSignedDiff(r,a))>Math.PI/2?Pn.normalize(r+Math.PI):r;return ii(t,n,s,Nn(o,"meters"),ye(l,"radians","geographic"),"geodesic"),t[2]=i[2],!0}function lr(t,e,n,i){Ot(e,{start:n,end:i,type:T.LINE},t),t[2]=e[2]}let cr=class ri extends lt{constructor(e,n,i,s=L.ALL){super(i,s),this.lineStart=e,this.lineEnd=n}equals(e){return e instanceof ri&&_(this.lineStart,e.lineStart)&&_(this.lineEnd,e.lineEnd)}},ai=class extends Le{constructor({referenceLine:e,lineStart:n,targetPoint:i,isDraped:s}){const r=de(n),{left:a,right:o}=e;Ae(r,Xi(r,r,o),a),super(i,new Wn(n,r),s,L.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new X(O.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new cr(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new X(O.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const n={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{_(e.right,i.edge.left)&&(i.fadeLeft=!1,n.fadeRight=!1),_(e.right,i.edge.right)&&(i.fadeRight=!1,n.fadeRight=!1),_(e.left,i.edge.right)&&(i.fadeRight=!1,n.fadeLeft=!1),_(e.left,i.edge.left)&&(i.fadeLeft=!1,n.fadeLeft=!1)}),this._referenceLines.push(n)}},ur=class extends ct{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,a=[];if(s<2)return a;const{view:o}=this,l=P(e,n.spatialReference,x,o),c=$(i.vertices[r-1].pos,o,n),u=$(i.vertices[0].pos,o,n),d=i.edges[s-1];let f=d;do{if(this.edgeExceedsShortLineThreshold(f,n)){const g=et(f,o,n);this._checkEdgeForParallelLines(g,c,e,l,n,a),this._checkEdgeForParallelLines(g,u,e,l,n,a)}f=f.leftVertex.leftEdge}while(f&&f!==d);return a}snapExistingVertex(e,n){const i=[],s=n.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:a}=this,o=P(e,n.spatialReference,x,a),l=s.leftEdge,c=s.rightEdge,u=r.vertices[0],d=$(u.pos,a,n),f=r.vertices.length,g=r.vertices[f-1],v=$(g.pos,a,n),w=r.edges[0];let m=w;do{if(m!==l&&m!==c&&this.edgeExceedsShortLineThreshold(m,n)){const V=et(m,a,n);l&&this._checkEdgeForParallelLines(V,$(l.leftVertex.pos,a,n),e,o,n,i),c&&this._checkEdgeForParallelLines(V,$(c.rightVertex.pos,a,n),e,o,n,i),s===u?this._checkEdgeForParallelLines(V,v,e,o,n,i):s===g&&this._checkEdgeForParallelLines(V,d,e,o,n,i)}m=m.rightVertex.rightEdge}while(m&&m!==w);return i}_checkEdgeForParallelLines(e,n,i,s,r,a){const o=e.left,l=e.right;if($t(pe,n,o,l),ge(pe,n)<G.parallelLineThreshold)return;$t(pe,i,o,l,n);const{spatialReference:c,pointer:u}=r,d=ce(U(pe[0],pe[1],i[2]));if(we(s,P(d,c,x,this.view))<this.squaredProximityThreshold(u)){if(this.isVertical(d,n,r)||this.isVertical(o,l,r)||dr(e,a))return;a.push(new ai({referenceLine:e,lineStart:n,targetPoint:d,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}};function dr(t,e){const n=t.left,i=t.right;for(const s of e)if($t(pe,i,s.constraint.start,s.constraint.end,n),ge(pe,i)<G.parallelLineThreshold)return s.addReferenceLine(t),!0;return!1}const pe=k();class hr extends ct{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=[];if(i.vertices.length<2)return s;const{view:r}=this,a=P(e,n.spatialReference,x,r),o=i.vertices.at(-1);this._checkForSnappingCandidate(oe.LastVertex,s,o.leftEdge,o,o.leftEdge.leftVertex,e,a,n);const l=i.vertices[0];return this._checkForSnappingCandidate(oe.FirstVertex,s,l.rightEdge,l,l.rightEdge.rightVertex,e,a,n),s}snapExistingVertex(e,n){const i=[],s=n.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,a=P(e,n.spatialReference,x,r),o=s.leftEdge,l=s.rightEdge;if(o?.leftVertex.leftEdge){const c=o.leftVertex.leftEdge;this._checkForSnappingCandidate(oe.ExistingEdge,i,c,c.rightVertex,c.leftVertex,e,a,n)}if(l?.rightVertex.rightEdge){const c=l.rightVertex.rightEdge;this._checkForSnappingCandidate(oe.ExistingEdge,i,c,c.leftVertex,c.rightVertex,e,a,n)}return i}_checkForSnappingCandidate(e,n,i,s,r,a,o,l){if(!this.edgeExceedsShortLineThreshold(i,l))return;const c=this.view,u=$(s.pos,c,l),d=$(r.pos,c,l);pr(gn,d,u,a,l),this._checkForSnappingCandidateAlongProjectedRay(e,n,d,u,gn,a,o,l)}_checkForSnappingCandidateAlongProjectedRay(e,n,i,s,r,a,o,l){const{spatialReference:c,pointer:u}=l,d=se(Rt,a,s),f=Me(r,d)/Pe(r),g=Re(Rt,s,r,f),v=ce(U(g[0],g[1],a[2]));if(we(o,P(v,c,x,this.view))>this.squaredProximityThreshold(u)||this.isVertical(v,s,l)||this.isVertical(s,i,l))return;const w=b(y(),s,r,Math.sign(f));n.push(new Kt({targetPoint:v,constraint:new Un(s,w),previousVertex:i,otherVertex:s,otherVertexType:_e.CENTER,selfSnappingType:e,isDraped:l.elevationInfo?.mode==="on-the-ground"}))}}function pr(t,e,n,i,s){fr(t,e,n,i,s)||gr(t,e,n)}function fr(t,e,n,i,{spatialReference:s}){const r=Ne(e,n,s,s);if(r==null)return!1;const a=Ne(n,i,s,s);if(a==null)return!1;const o=Math.sign(Pn.shortestSignedDiff(r,a))*Math.PI*.5,l=ye(r+o,"radians","geographic"),c=y(),u=Mn(n,i,s);return u!=null&&(ii(c,n,s,Nn(u,"meters"),l,"geodesic"),Ae(t,c,n),!0)}function gr(t,e,n){const i=se(Rt,n,e);Z(t,i[1],-i[0],0)}const Rt=k(),gn=y();class oi extends Le{constructor({targetPoint:e,point1:n,point2:i,isDraped:s}){super(e,new Zn(Ji(y(),n,i,.5),.5*Nt(n,i)),s,L.SELF),this._p1=n,this._p2=i}get hints(){return[new X(O.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new X(O.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new ei(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}}let yr=class extends ct{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(n.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,o=i.vertices[0],l=i.vertices[r-1],c=$(o.pos,a,n),u=$(l.pos,a,n);return this._processCandidateProposal(c,u,e,n,s),s}snapExistingVertex(e,n){const i=[],s=n.vertexHandle,r=s.component;if(r.edges.length<2||n.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:a}=this,o=$(s.leftEdge.leftVertex.pos,a,n),l=$(s.rightEdge.rightVertex.pos,a,n);return this._processCandidateProposal(o,l,e,n,i),i}_processCandidateProposal(e,n,i,s,r){if(!this.exceedsShortLineThreshold(e,n,s))return;const a=xn(yn,e,n,.5),o=.5*Nt(e,n),l=rs(yn,i,a,o),c=ce(U(l[0],l[1],i[2])),{spatialReference:u,pointer:d}=s,f=P(i,u,x,this.view);if(we(f,P(c,u,x,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(e,c,s)||this.isVertical(c,n,s))return;r.push(new oi({targetPoint:c,point1:e,point2:n,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}};const yn=k();let me=class extends xe{constructor(t){super(t),this.updating=!1,this._snappers=new fe,this._domain=L.SELF}initialize(){this._snappers.push(new ur(this.view,this.options),new rr(this.view,this.options),new hr(this.view,this.options),new yr(this.view,this.options))}set options(t){this._set("options",t);for(const e of this._snappers)e.options=t}async fetchCandidates(t,e,n){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const i=[];for(const s of this._snappers.items)for(const r of s.snap(t,n))i.push(r);return Yt(t,i),i}};h([p({readOnly:!0})],me.prototype,"updating",void 0),h([p({constructOnly:!0})],me.prototype,"view",void 0),h([p()],me.prototype,"options",null),me=h([he("esri.views.interactive.snapping.SelfSnappingEngine")],me);function vr(t,e){return[new me({view:t,options:e}),new ne({view:t,options:e,spatialReference:t.spatialReference})]}class Xt extends lt{constructor(e,n,i=L.ALL){super(n,i),this.intersectionPoint=e}equals(e){return e instanceof Xt&&_(this.intersectionPoint,e.intersectionPoint)}}class ke extends Le{constructor(e,n,i,s){super(e,new $e(e),s,L.ALL),this.first=n,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Xt(this.targetPoint,this.isDraped,this.domain)]}}let W=class extends Qi.EventedMixin(xe){constructor(t){super(t),this.options=new An,this.snappingEnginesFactory=vr,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ie.MAIN}initialize(){this.addHandles([le(()=>{const{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:n,distance:i}=this.options;return{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:n,distance:i}},()=>{this.doneSnapping(),this.emit("changed")},_t),le(()=>this.options,t=>{for(const e of this._engines)e.options=t},_t),le(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:t,snappingEnginesFactory:e})=>this._recreateEngines(t,e),Be)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)}_recreateEngines(t,e){if(this._destroyEngines(),!t)return;const{view:n,options:i}=this;this._engines=e(n,i)}_destroyEngines(){for(const t of this._engines)t.destroy();this._engines=[]}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,n=t*e;return n*n}snap(t){return Sr(t)?this._snapMultiPoint(t):this._snapSinglePoint(t)}update(t){const{point:e,context:n}=t;this._removeVisualization();const i=this._currentMainCandidate;if(i==null)return e;const s=this._selectUpdateInput(t);if(s==null)return e;const{spatialReference:r}=n,a=en(s,r);if(a==null)return e;const{view:o}=this,{elevationInfo:l,visualizer:c}=n,u=[],d=Te(a,o,l),f=i.constraint.closestTo(d);if(!this._arePointsWithinScreenThreshold(d,f,n)||!wt(i,n.drawConstraints))return this._resetSnappingState(),e;i.targetPoint=ce(f),u.push(...i.hints);for(const g of this._currentOtherActiveCandidates)wt(g,n.drawConstraints)&&(g.targetPoint=ce(f),u.push(...g.hints));return c!=null&&this.addHandles(c.draw(u,{spatialReference:r,elevationInfo:Er(n),view:o,selfSnappingZ:n.selfSnappingZ}),vt),sn(f,o,e,n)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:t,scenePoint:e}){switch(this._currentSnappedType){case ie.MAIN:return t;case ie.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ie.MAIN}_removeVisualization(){this.removeHandles(vt)}async _snapSinglePoint({point:t,context:e,signal:n}){const{view:i}=this,{elevationInfo:s}=e,r=Te(t,i,s),a=await this._fetchCandidates(r,L.ALL,e,n);return this._createSnapResult(r,ie.MAIN,a,i,t,e,n)}async _snapMultiPoint({point:t,scenePoint:e,context:n,signal:i}){const{view:s}=this,{coordinateHelper:r,elevationInfo:a,spatialReference:o}=n;await es(e.spatialReference,o);const l=en(e,o),c=Te(l,s,a),u=await this._fetchCandidates(c,L.FEATURE,n,i);if(u.length>0){const g=await this._fetchCandidates(c,L.SELF,n,i);return this._createSnapResult(c,ie.SCENE,[...u,...g],s,l,n,i)}const d=Te(t,s,a),f=await this._fetchCandidates(d,L.SELF,n,i);return this._createSnapResult(d,ie.MAIN,f,s,{z:r.hasZ()&&t.hasZ?t.z??0:void 0,m:r.hasM()&&t.hasM?t.m??0:void 0},n,i)}async _fetchCandidates(t,e,n,i){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(t,e,n,i)))).flat()}_createSnapResult(t,e,n,i,s,r,a){return{get valid(){return!ts(a)},apply:()=>{const{spatialReference:o}=r,{snappedPoint:l,hints:c}=this._processCandidates(t,e,n,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(c,{spatialReference:o,elevationInfo:x,view:i,selfSnappingZ:r.selfSnappingZ}),vt),sn(l,i,s,r)}}}_processCandidates(t,e,n,i){if(n.length<1)return this.doneSnapping(),{snappedPoint:t,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Yt(t,n);const s=this._currentMainCandidate;if(s!=null){const r=mr(s,n);if(r>=0){if(!(n[r]instanceof ke))return this._intersectWithOtherCandidates(r,n,t,e,i);if(this._arePointsWithinScreenThreshold(t,s.targetPoint,i))return this._updateSnappingCandidate(s,e,n,i)}}return this._intersectWithOtherCandidates(0,n,t,e,i)}_intersectWithOtherCandidates(t,e,n,i,s){const{coordinateHelper:r}=s,a=e[t],o=[];for(let l=0;l<e.length;++l){if(l===t)continue;const c=e[l],u=a.constraint.intersect(c.constraint);if(u)for(const d of u.closestPoints(a.targetPoint))o.push([new ke(ce(d),a,c,c.isDraped),this._squaredScreenDistance(n,d,r)])}return o.length>0&&(o.sort((l,c)=>l[1]-c[1]),o[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(o[0][0],i,e,s):wt(a,s.drawConstraints)?this._updateSnappingCandidate(a,i,e,s):{snappedPoint:n,hints:[]}}_updateSnappingCandidate(t,e,n,i){this.doneSnapping(),this._currentMainCandidate=t,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...t.hints);for(const a of n){if(t instanceof ke){if(a.constraint.equals(t.first.constraint)||a.constraint.equals(t.second.constraint))continue}else if(a.constraint.equals(t.constraint))continue;const o=a.constraint.closestTo(s);this._squaredScreenDistance(o,s,i.coordinateHelper)<wr()&&(a.targetPoint=s,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(t){return t==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(t,e,n){return this._squaredScreenDistance(t,e,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(t,e,n){return we(this._toScreen(t,n),this._toScreen(e,n))}_toScreen(t,e){return P(t,e.spatialReference,x,this.view)}get test(){}};var ie;h([p({constructOnly:!0})],W.prototype,"view",void 0),h([p()],W.prototype,"options",void 0),h([p({readOnly:!0})],W.prototype,"updating",null),h([p()],W.prototype,"snappingEnginesFactory",void 0),h([p()],W.prototype,"_engines",void 0),h([p()],W.prototype,"_squaredMouseProximityThreshold",null),h([p()],W.prototype,"_squaredTouchProximityThreshold",null),W=h([he("esri.views.interactive.snapping.SnappingManager")],W),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(ie||(ie={}));const vt="visualization-handle";function wr(){return G.satisfiesConstraintScreenThreshold*G.satisfiesConstraintScreenThreshold}function wt(t,e){return!e||e.direction==null&&e.distance==null||!(t instanceof Jn||t instanceof Qn||t instanceof ni||t instanceof ai||t instanceof oi)&&(!(t instanceof Kt)||e.direction==null&&t.selfSnappingType===oe.LastVertex)}function mr(t,e){return t instanceof ke?mt(e,t.first)>=0&&mt(e,t.second)>=0?0:-1:mt(e,t)}function mt(t,e){let n=-1;for(let i=0;i<t.length;++i)if(e.constraint.equals(t[i].constraint)){n=i;break}return n}function Sr(t){return t.scenePoint!=null}function Er({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?x:e}const Ge=new Map;function Jr(t){if(!Ge.has(t)){const i=us(t,{distance:10}),s=xr(t,i.options);Ge.set(t,{referenceCount:0,snappingManager:s,remove:()=>{i.remove(),s.destroy()}})}const e=Ge.get(t);e.referenceCount++;const n=ns(()=>_r(t,e));return{snappingManager:e.snappingManager,...n}}function _r(t,e){e.referenceCount--,e.referenceCount>0||is(()=>{e.referenceCount===0&&(e.remove(),Ge.delete(t))})}function xr(t,e){return new W({view:t,options:e,snappingEnginesFactory:(n,i)=>[new ne({view:t,spatialReference:t.spatialReference,options:i})]})}export{z as A,Wt as B,Es as C,Un as D,L as E,tr as F,pn as G,Wr as H,bs as I,j as L,ii as M,jr as N,er as R,Vr as T,Yr as U,Ls as Z,Qn as a,Fr as b,Jr as c,U as d,X as e,Yt as f,$e as g,cr as h,ei as i,Dr as j,G as k,Ir as l,Cr as m,Bt as n,Xt as o,ce as p,O as q,Jn as r,lt as s,Te as t,C as u,un as v,sn as w,Zn as x,Or as y,tt as z};
